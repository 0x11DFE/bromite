From: csagan5 <32685696+csagan5@users.noreply.github.com>
Date: Sun, 18 Feb 2018 22:15:25 +0100
Subject: Play videos in background

Break Page Visibility API and Fullscreen API for youtube.com and vimeo.com
Original Javascript code by timdream
---
 third_party/blink/renderer/core/dom/BUILD.gn    |  1 +
 third_party/blink/renderer/core/dom/document.cc | 17 +++++++++++++----
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/third_party/blink/renderer/core/dom/BUILD.gn b/third_party/blink/renderer/core/dom/BUILD.gn
--- a/third_party/blink/renderer/core/dom/BUILD.gn
+++ b/third_party/blink/renderer/core/dom/BUILD.gn
@@ -148,6 +148,7 @@ blink_core_sources("dom") {
     "events/window_event_context.cc",
     "events/window_event_context.h",
     "extensions/dont-track-me.h",
+    "extensions/video-bg-play.h",
     "exception_code.h",
     "first_letter_pseudo_element.cc",
     "first_letter_pseudo_element.h",
diff --git a/third_party/blink/renderer/core/dom/document.cc b/third_party/blink/renderer/core/dom/document.cc
--- a/third_party/blink/renderer/core/dom/document.cc
+++ b/third_party/blink/renderer/core/dom/document.cc
@@ -222,6 +222,7 @@
 #include "third_party/blink/renderer/core/page/scrolling/scrolling_coordinator.h"
 #include "third_party/blink/renderer/core/page/scrolling/snap_coordinator.h"
 #include "third_party/blink/renderer/core/page/scrolling/top_document_root_scroller_controller.h"
+#include "extensions/video_bg_play.h"
 #include "third_party/blink/renderer/core/paint/compositing/paint_layer_compositor.h"
 #include "third_party/blink/renderer/core/paint/first_meaningful_paint_detector.h"
 #include "third_party/blink/renderer/core/paint/paint_layer_scrollable_area.h"
@@ -5891,17 +5892,25 @@ void Document::FinishedParsing() {
 
   // determine whether this is a Google search results page
   const SecurityOrigin *origin = GetSecurityOrigin();
-  if (origin) {
+  auto* bodyElement = body();
+  if (origin && bodyElement) {
     WTF::String domain = origin->Domain();
     size_t pos = domain.Find(".google.");
-    auto* bodyElement = body();
-    if (bodyElement && (pos != WTF::kNotFound) && (domain.length() - pos - 8 < 4)) {
+    if ((pos != WTF::kNotFound) && (domain.length() - pos - 8 < 4)) {
       LOG(INFO) << "injecting anti-AMP-cure Javascript payload";
       HTMLScriptElement* e = HTMLScriptElement::Create(*this, CreateElementFlags());
       e->setText(ANTI_AMP_CURE_JS);
       bodyElement->AppendChild(e);
     }
-  }
+
+    // check for eligibility of the video bg fix
+    if ((WTF::kNotFound != domain.Find("youtube.com")) || (WTF::kNotFound != domain.Find("vimeo.com"))) {
+      LOG(INFO) << "injecting video-bg-play Javascript payload";
+      HTMLScriptElement* e = HTMLScriptElement::Create(*this, CreateElementFlags());
+      e->setText(VIDEO_BG_PLAY_JS);
+      bodyElement->AppendChild(e);
+    }
+  } // has origin and body element
 
   FirstMeaningfulPaintDetector::From(*this).CheckNetworkStable();
 }
-- 
2.7.4

